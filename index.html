<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Coach AI - Your Hands-Free Cooking Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --accent: #FFE66D;
            --dark: #2D3436;
            --light: #FFFFFF;
            --success: #26DE81;
            --purple: #A55EEA;
            --pink: #FD79A8;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            color: var(--dark);
            position: relative;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .floating-shapes {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            animation: float 20s infinite ease-in-out;
            opacity: 0.1;
        }

        .shape:nth-child(1) {
            width: 80px;
            height: 80px;
            background: var(--accent);
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .shape:nth-child(2) {
            width: 120px;
            height: 120px;
            background: var(--primary);
            top: 60%;
            right: 10%;
            animation-delay: 5s;
        }

        .shape:nth-child(3) {
            width: 60px;
            height: 60px;
            background: var(--secondary);
            bottom: 20%;
            left: 30%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            33% { transform: translateY(-30px) rotate(120deg); }
            66% { transform: translateY(30px) rotate(240deg); }
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 3.5em;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            font-weight: 800;
            background: linear-gradient(45deg, #FFE66D, #FF6B6B);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            flex: 1;
            animation: fadeInUp 0.8s ease-out;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .upload-section {
            text-align: center;
            padding: 20px;
        }

        .upload-section h2 {
            margin-bottom: 25px;
            font-size: 2.2em;
            background: linear-gradient(45deg, var(--purple), var(--pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .upload-section p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }

        .upload-box {
            border: 3px dashed var(--purple);
            border-radius: 20px;
            padding: 50px 30px;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: linear-gradient(145deg, rgba(165, 94, 234, 0.05), rgba(253, 121, 168, 0.05));
            position: relative;
            overflow: hidden;
        }

        .upload-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            transform: scale(0);
            transition: transform 0.6s ease;
        }

        .upload-box:hover::before {
            transform: scale(1);
        }

        .upload-box:hover {
            border-color: var(--pink);
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(165, 94, 234, 0.3);
        }

        .upload-box.dragover {
            background: linear-gradient(145deg, rgba(165, 94, 234, 0.2), rgba(253, 121, 168, 0.2));
            transform: scale(1.05);
            border-style: solid;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .recipe-input {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            font-size: 16px;
            margin: 20px 0;
            resize: vertical;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            font-family: 'Courier New', monospace;
        }

        .recipe-input:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 20px rgba(165, 94, 234, 0.2);
            transform: scale(1.02);
        }

        .hands-free-option {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            font-size: 1.2em;
            padding: 15px;
            background: linear-gradient(145deg, rgba(78, 205, 196, 0.1), rgba(255, 230, 109, 0.1));
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .hands-free-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .hands-free-option input {
            margin-right: 15px;
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .start-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--pink) 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 1.4em;
            font-weight: 700;
            border-radius: 35px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .start-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .start-button:hover::before {
            width: 300px;
            height: 300px;
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 107, 107, 0.5);
        }

        .start-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .cooking-interface {
            display: none;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-display {
            text-align: center;
            margin-bottom: 40px;
        }

        .step-number {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 20px;
            padding: 10px 25px;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white;
            border-radius: 25px;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .step-content {
            font-size: 1.5em;
            line-height: 1.8;
            margin-bottom: 30px;
            padding: 30px;
            background: linear-gradient(145deg, rgba(255, 230, 109, 0.1), rgba(255, 107, 107, 0.1));
            border-radius: 20px;
            border-left: 5px solid var(--primary);
            animation: fadeIn 0.5s ease-out;
            position: relative;
        }

        .step-content::before {
            content: '💡';
            position: absolute;
            top: -15px;
            left: 20px;
            font-size: 2em;
            background: white;
            padding: 0 10px;
        }

        .voice-indicator {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 40px rgba(165, 94, 234, 0.4);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }

        .voice-indicator::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
            border-radius: 50%;
            opacity: 0.3;
            z-index: -1;
            animation: ripple 2s ease-out infinite;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 0.3;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        .voice-indicator.listening {
            animation: pulse 1.5s infinite;
            box-shadow: 0 10px 50px rgba(165, 94, 234, 0.6);
        }

        .voice-indicator.speaking {
            animation: glow 1s infinite alternate;
            background: linear-gradient(135deg, var(--accent) 0%, var(--primary) 100%);
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .control-button {
            background: white;
            border: 3px solid var(--secondary);
            color: var(--secondary);
            padding: 15px 35px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .control-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--secondary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: -1;
        }

        .control-button:hover::before {
            width: 200px;
            height: 200px;
        }

        .control-button:hover {
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.3);
        }

        .control-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .timers-section {
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(145deg, rgba(165, 94, 234, 0.1), rgba(78, 205, 196, 0.1));
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .timers-section h3 {
            color: var(--purple);
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .timer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .timer-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .timer-label {
            font-weight: 600;
            color: var(--dark);
        }

        .timer-time {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 40px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary) 0%, var(--primary) 100%);
            transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.5);
        }

        .completion-screen {
            text-align: center;
            padding: 60px 40px;
            display: none;
            animation: zoomIn 0.8s ease-out;
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .completion-screen h2 {
            font-size: 3.5em;
            margin-bottom: 25px;
            background: linear-gradient(45deg, var(--success), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: bounce 1s ease-out;
        }

        .completion-emoji {
            font-size: 5em;
            margin-bottom: 20px;
            animation: spin 1s ease-out;
        }

        @keyframes spin {
            from { transform: rotate(0deg) scale(0); }
            to { transform: rotate(360deg) scale(1); }
        }

        .completion-screen p {
            font-size: 1.4em;
            margin-bottom: 40px;
            color: var(--dark);
        }

        .mic-icon {
            width: 50px;
            height: 50px;
            fill: white;
        }

        .error-message {
            color: white;
            margin-top: 20px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 10px;
            display: none;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
            animation: shake 0.5s ease-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .success-message {
            color: white;
            margin-top: 20px;
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--success), #20bf6b);
            border-radius: 10px;
            display: none;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(38, 222, 129, 0.3);
            animation: fadeIn 0.5s ease-out;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2.5em;
            }
            
            .main-content {
                padding: 25px;
            }
            
            .voice-indicator {
                bottom: 20px;
                right: 20px;
                width: 80px;
                height: 80px;
            }
            
            .mic-icon {
                width: 40px;
                height: 40px;
            }

            .control-buttons {
                gap: 10px;
            }

            .control-button {
                padding: 12px 25px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <div class="app-container">
        <div class="header">
            <h1>Kitchen Coach AI 🎉</h1>
            <p>Your magical hands-free cooking companion!</p>
        </div>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <h2>Let's Create Something Delicious! 🍳</h2>
                <p>Drop your recipe below and let's turn it into magic!</p>
                
                <div class="upload-box" id="uploadBox">
                    <div class="upload-icon">📱</div>
                    <p><strong>Tap to upload</strong> a recipe (PDF, DOC, TXT, or image)</p>
                    <p style="font-size: 0.9em; margin-top: 10px; opacity: 0.7;">or drag & drop your file here</p>
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" style="display: none;">
                </div>

                <textarea class="recipe-input" id="recipeInput" placeholder="Or paste your recipe here! Try one of these:

🍪 COOKIES: Press Alt+1 for Chocolate Chip Cookies
🍝 PASTA: Press Alt+2 for Garlic Pasta
🥘 STIR-FRY: Press Alt+3 for Veggie Stir-Fry

Or paste any recipe with ingredients and numbered steps!"></textarea>

                <div class="hands-free-option">
                    <input type="checkbox" id="handsFreeModeCheckbox">
                    <label for="handsFreeModeCheckbox">✨ Enable magical hands-free mode (say "Hey Coach")</label>
                </div>

                <button class="start-button" id="startButton" disabled>Let's Cook! 🚀</button>
                
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </div>

            <!-- Cooking Interface -->
            <div class="cooking-interface" id="cookingInterface">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="step-display">
                    <div class="step-number" id="stepNumber"></div>
                    <div class="step-content" id="stepContent"></div>
                </div>

                <div class="control-buttons">
                    <button class="control-button" id="prevButton">⬅️ Previous</button>
                    <button class="control-button" id="repeatButton">🔁 Repeat</button>
                    <button class="control-button" id="nextButton">Next ➡️</button>
                    <button class="control-button" id="helpButton">💬 Help</button>
                </div>

                <div class="timers-section" id="timersSection" style="display: none;">
                    <h3>⏱️ Active Timers</h3>
                    <div id="timersList"></div>
                </div>
            </div>

            <!-- Completion Screen -->
            <div class="completion-screen" id="completionScreen">
                <div class="completion-emoji">🎊</div>
                <h2>You're a Kitchen Superstar!</h2>
                <p>You totally crushed that recipe! Your delicious creation awaits! 🌟</p>
                <button class="start-button" onclick="location.reload()">Cook Something Else! 🍴</button>
            </div>
        </div>

        <!-- Voice Indicator -->
        <div class="voice-indicator" id="voiceIndicator" style="display: none;" title="Click to toggle voice listening">
            <svg class="mic-icon" viewBox="0 0 24 24">
                <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" />
            </svg>
        </div>
    </div>

    <script>
        // Global state
        let recipe = null;
        let currentStep = -1;
        let isListening = false;
        let isSpeaking = false;
        let handsFreeMode = false;
        let recognition = null;
        let timers = new Map();
        let continuousListening = false;
        let recognitionAvailable = false;

        // DOM elements
        const uploadSection = document.getElementById('uploadSection');
        const cookingInterface = document.getElementById('cookingInterface');
        const completionScreen = document.getElementById('completionScreen');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const recipeInput = document.getElementById('recipeInput');
        const startButton = document.getElementById('startButton');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const handsFreeModeCheckbox = document.getElementById('handsFreeModeCheckbox');
        const fileInput = document.getElementById('fileInput');
        const uploadBox = document.getElementById('uploadBox');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            checkBrowserSupport();
        });

        function setupEventListeners() {
            recipeInput.addEventListener('input', checkRecipeValidity);
            startButton.addEventListener('click', startCooking);
            uploadBox.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('dragover');
            });
            
            uploadBox.addEventListener('dragleave', () => {
                uploadBox.classList.remove('dragover');
            });
            
            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // Control buttons
            document.getElementById('prevButton').addEventListener('click', previousStep);
            document.getElementById('nextButton').addEventListener('click', nextStep);
            document.getElementById('repeatButton').addEventListener('click', repeatStep);
            document.getElementById('helpButton').addEventListener('click', showHelp);
            
            voiceIndicator.addEventListener('click', toggleListening);
        }

        function checkBrowserSupport() {
            // Check for speech synthesis
            if (!('speechSynthesis' in window)) {
                showError('Your browser doesn\'t support text-to-speech. Please use Chrome, Edge, or Safari.');
                return;
            }
            
            // Check for speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showError('Voice commands aren\'t supported in your browser. The app will work with buttons only.');
                handsFreeModeCheckbox.disabled = true;
                handsFreeModeCheckbox.parentElement.style.opacity = '0.5';
                recognitionAvailable = false;
            } else {
                recognitionAvailable = true;
            }
        }

        function checkRecipeValidity() {
            const hasContent = recipeInput.value.trim().length > 50;
            startButton.disabled = !hasContent;
            
            if (hasContent) {
                startButton.textContent = "Let's Cook! 🚀";
            }
        }

        function showError(message, persistent = false) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            if (!persistent) {
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showError('File upload parsing coming soon! Please paste your recipe text for now.');
            recipeInput.value = `[Recipe from ${file.name}]\n\nPlease paste the recipe text for now. Try Alt+1, Alt+2, or Alt+3 for examples!`;
            checkRecipeValidity();
        }

        function handleFiles(files) {
            if (files.length > 0) {
                handleFileUpload({ target: { files: [files[0]] } });
            }
        }

        function parseRecipe(recipeText) {
            const lines = recipeText.trim().split('\n').filter(line => line.trim());
            const recipe = {
                title: '',
                ingredients: [],
                steps: [],
                totalSteps: 0
            };
            
            // Extract title (usually first non-empty line)
            recipe.title = lines[0].replace(/[#*]/g, '').trim() || 'Your Delicious Recipe';
            
            let section = '';
            let stepNumber = 1;
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                const lowerLine = line.toLowerCase();
                
                // Detect sections
                if (lowerLine.includes('ingredient') || lowerLine.includes('you need') || lowerLine.includes('you\'ll need')) {
                    section = 'ingredients';
                    continue;
                } else if (lowerLine.includes('instruction') || lowerLine.includes('direction') || lowerLine.includes('method') || lowerLine.includes('step')) {
                    section = 'instructions';
                    continue;
                }
                
                // Parse ingredients
                if (section === 'ingredients' && line.startsWith('-')) {
                    recipe.ingredients.push(line.substring(1).trim());
                }
                
                // Parse instructions - multiple formats
                if (section === 'instructions' || (line.match(/^\d+[\.\)]\s*/) && line.length > 20)) {
                    const numberedMatch = line.match(/^\d+[\.\)]\s*(.*)/);
                    const stepText = numberedMatch ? numberedMatch[1] : line;
                    
                    // Only add as step if it's substantial
                    if (stepText.length > 15 && !stepText.toLowerCase().includes('ingredient')) {
                        recipe.steps.push({
                            number: stepNumber++,
                            text: stepText.trim(),
                            time: extractTime(stepText),
                            hasTimer: false
                        });
                    }
                } else if (line.length > 30 && section === '' && !line.includes(':')) {
                    // Assume longer lines might be steps if no section identified
                    recipe.steps.push({
                        number: stepNumber++,
                        text: line,
                        time: extractTime(line),
                        hasTimer: false
                    });
                }
            }
            
            // If no steps found, try a more aggressive parse
            if (recipe.steps.length === 0) {
                stepNumber = 1;
                for (const line of lines) {
                    if (line.length > 30 && !line.includes(':') && !line.toLowerCase().includes('ingredient')) {
                        recipe.steps.push({
                            number: stepNumber++,
                            text: line.trim(),
                            time: extractTime(line),
                            hasTimer: false
                        });
                    }
                }
            }
            
            // Still no steps? Create default steps based on ingredients
            if (recipe.steps.length === 0 && recipe.ingredients.length > 0) {
                recipe.steps = [
                    { number: 1, text: "Gather all your ingredients and equipment. Make sure everything is measured and ready to go!", time: null, hasTimer: false },
                    { number: 2, text: "Preheat your oven or stovetop as needed. Preparation is key to great cooking!", time: null, hasTimer: false },
                    { number: 3, text: "Combine your ingredients according to the recipe. Take your time and enjoy the process!", time: null, hasTimer: false },
                    { number: 4, text: "Cook or bake as directed. Keep an eye on things and trust your instincts!", time: null, hasTimer: false },
                    { number: 5, text: "Let it rest if needed, then serve and enjoy your amazing creation!", time: null, hasTimer: false }
                ];
            }
            
            recipe.totalSteps = recipe.steps.length;
            
            // Mark steps that have timers
            recipe.steps.forEach(step => {
                if (step.time) {
                    step.hasTimer = true;
                }
            });
            
            return recipe;
        }

        function extractTime(text) {
            const patterns = [
                /(\d+)\s*-\s*(\d+)\s*(minutes?|mins?|hours?|hrs?)/i,
                /(\d+)\s*(minutes?|mins?|hours?|hrs?|seconds?|secs?)/i,
                /(\d+)\s*to\s*(\d+)\s*(minutes?|mins?|hours?|hrs?)/i
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    let value = parseInt(match[1]);
                    const unit = match[match.length - 1].toLowerCase();
                    
                    // For ranges, use the average
                    if (match[2] && !isNaN(parseInt(match[2]))) {
                        value = Math.round((parseInt(match[1]) + parseInt(match[2])) / 2);
                    }
                    
                    // Convert to minutes
                    if (unit.includes('hour')) return value * 60;
                    if (unit.includes('sec')) return Math.round(value / 60);
                    return value;
                }
            }
            return null;
        }

        function startCooking() {
            const recipeText = recipeInput.value.trim();
            if (!recipeText) return;
            
            recipe = parseRecipe(recipeText);
            handsFreeMode = handsFreeModeCheckbox.checked && recognitionAvailable;
            
            console.log('Parsed recipe:', recipe);
            
            // Initialize voice recognition if available and requested
            if (handsFreeMode && recognitionAvailable) {
                initializeVoiceRecognition();
            }
            
            // Switch to cooking interface
            uploadSection.style.display = 'none';
            cookingInterface.style.display = 'block';
            voiceIndicator.style.display = handsFreeMode ? 'flex' : 'none';
            
            // Start with welcome message
            const introMessage = `Awesome! We're making ${recipe.title}! ${recipe.totalSteps} delicious steps await. When you're ready to start, ${handsFreeMode ? 'say "Hey Coach, ready!" or just click next' : 'click next or say "ready"'}!`;
            speak(introMessage);
            
            updateStepDisplay();
        }

        function initializeVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                console.log('Voice recognition started');
                isListening = true;
                voiceIndicator.classList.add('listening');
            };
            
            recognition.onresult = (event) => {
                if (isSpeaking) return;
                
                const last = event.results.length - 1;
                const command = event.results[last][0].transcript.toLowerCase();
                
                console.log('Heard:', command);
                
                // Visual feedback
                voiceIndicator.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    voiceIndicator.style.transform = 'scale(1)';
                }, 200);
                
                // Process command
                if (handsFreeMode && command.includes('hey coach')) {
                    const actualCommand = command.replace('hey coach', '').trim();
                    processCommand(actualCommand);
                } else if (!handsFreeMode) {
                    processCommand(command);
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                if (event.error === 'not-allowed') {
                    showError('Microphone access needed for voice commands. Using button controls instead.');
                    handsFreeMode = false;
                    continuousListening = false;
                    voiceIndicator.style.display = 'none';
                } else if (event.error === 'no-speech') {
                    // Normal - just restart
                    if (continuousListening && !isSpeaking) {
                        setTimeout(() => startListening(), 100);
                    }
                } else if (event.error === 'network') {
                    showError('Voice recognition needs internet connection.');
                }
            };
            
            recognition.onend = () => {
                console.log('Voice recognition ended');
                isListening = false;
                voiceIndicator.classList.remove('listening');
                
                if (continuousListening && !isSpeaking && handsFreeMode) {
                    setTimeout(() => startListening(), 100);
                }
            };
            
            // Request microphone permission explicitly
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        console.log('Microphone permission granted');
                        continuousListening = true;
                        startListening();
                    })
                    .catch((err) => {
                        console.error('Microphone permission denied:', err);
                        showError('Microphone access needed for voice commands. Click allow when prompted!');
                        handsFreeMode = false;
                        voiceIndicator.style.display = 'none';
                    });
            } else {
                // Try anyway
                continuousListening = true;
                startListening();
            }
        }

        function startListening() {
            if (!recognition || isListening || isSpeaking) return;
            
            try {
                recognition.start();
                console.log('Started listening');
            } catch (e) {
                if (e.name === 'InvalidStateError') {
                    // Already started, stop and restart
                    try {
                        recognition.stop();
                        setTimeout(() => startListening(), 200);
                    } catch (e2) {
                        console.error('Could not restart:', e2);
                    }
                }
            }
        }

        function stopListening() {
            if (!recognition) return;
            
            continuousListening = false;
            try {
                recognition.stop();
                console.log('Stopped listening');
            } catch (e) {
                console.error('Error stopping recognition:', e);
            }
        }

        function toggleListening() {
            if (continuousListening) {
                continuousListening = false;
                stopListening();
                showSuccess('Voice listening paused');
            } else {
                continuousListening = true;
                startListening();
                showSuccess('Voice listening activated! Say "Hey Coach" followed by your command');
            }
        }

        function processCommand(command) {
            console.log('Processing command:', command);
            
            // Provide feedback
            showSuccess(`Heard: "${command}"`);
            
            // Commands
            if (command.includes('ready') || command.includes('start') || command.includes('begin') || command.includes('let\'s go') || command.includes('next')) {
                if (currentStep === -1) {
                    nextStep();
                } else if (command.includes('next')) {
                    nextStep();
                }
            } else if (command.includes('previous') || command.includes('back') || command.includes('last')) {
                previousStep();
            } else if (command.includes('repeat') || command.includes('again') || command.includes('what') || command.includes('say that')) {
                repeatStep();
            } else if (command.includes('help')) {
                showHelp();
            } else if (command.includes('timer') && command.includes('start')) {
                startCurrentStepTimer();
            } else if ((command.includes('done') || command.includes('finished') || command.includes('complete')) && currentStep < recipe.steps.length - 1) {
                nextStep();
            } else if (command.includes('how much time') || command.includes('check timer')) {
                checkTimers();
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                window.speechSynthesis.cancel();
                
                // Stop listening while speaking
                if (recognition && isListening) {
                    recognition.stop();
                }
                
                isSpeaking = true;
                voiceIndicator.classList.add('speaking');
                voiceIndicator.classList.remove('listening');
                
                const utterance = new SpeechSynthesisUtterance(text);
                
                // Customize voice settings for friendliness
                utterance.rate = 0.95;
                utterance.pitch = 1.1;
                utterance.volume = 1.0;
                
                // Try to select a friendly voice
                const voices = window.speechSynthesis.getVoices();
                const preferredVoices = voices.filter(voice => 
                    voice.name.includes('Samantha') || 
                    voice.name.includes('Google US English') ||
                    voice.name.includes('Microsoft Zira') ||
                    voice.name.includes('Female')
                );
                
                if (preferredVoices.length > 0) {
                    utterance.voice = preferredVoices[0];
                }
                
                utterance.onend = () => {
                    isSpeaking = false;
                    voiceIndicator.classList.remove('speaking');
                    
                    // Resume listening if needed
                    if (continuousListening && handsFreeMode) {
                        setTimeout(() => startListening(), 500);
                    }
                };
                
                utterance.onerror = (e) => {
                    console.error('Speech synthesis error:', e);
                    isSpeaking = false;
                    voiceIndicator.classList.remove('speaking');
                };
                
                window.speechSynthesis.speak(utterance);
            }
        }

        function updateStepDisplay() {
            const progressFill = document.getElementById('progressFill');
            const stepNumber = document.getElementById('stepNumber');
            const stepContent = document.getElementById('stepContent');
            
            if (currentStep === -1) {
                stepNumber.textContent = '🎯 Ready to Start!';
                stepContent.innerHTML = `<strong>${recipe.title}</strong><br><br>We'll cook through ${recipe.totalSteps} easy steps together. I'll guide you every step of the way! 🌟`;
                progressFill.style.width = '0%';
            } else if (currentStep < recipe.steps.length) {
                const step = recipe.steps[currentStep];
                stepNumber.textContent = `Step ${step.number} of ${recipe.totalSteps}`;
                stepContent.innerHTML = step.text;
                progressFill.style.width = `${((currentStep + 1) / recipe.totalSteps) * 100}%`;
                
                // Build speech text
                let speechText = `Step ${step.number}: ${step.text}`;
                
                if (step.hasTimer) {
                    speechText += ` This step takes about ${step.time} minutes. When you've started, say "Hey Coach, start timer" and I'll keep track for you!`;
                }
                
                // Add encouragement
                if (currentStep === 0) {
                    speechText = "Let's do this! " + speechText;
                } else if (currentStep === Math.floor(recipe.totalSteps / 2)) {
                    speechText = "You're halfway there, doing great! " + speechText;
                } else if (currentStep === recipe.totalSteps - 1) {
                    speechText = "Final step, you're almost done! " + speechText;
                }
                
                speak(speechText);
            }
            
            // Update buttons
            document.getElementById('prevButton').disabled = currentStep <= -1;
            document.getElementById('nextButton').disabled = currentStep >= recipe.steps.length - 1;
        }

        function nextStep() {
            if (currentStep < recipe.steps.length - 1) {
                currentStep++;
                updateStepDisplay();
            } else if (currentStep === recipe.steps.length - 1) {
                completeRecipe();
            }
        }

        function previousStep() {
            if (currentStep > -1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function repeatStep() {
            if (currentStep >= 0 && currentStep < recipe.steps.length) {
                const step = recipe.steps[currentStep];
                speak(`Let me repeat that: ${step.text}`);
            } else if (currentStep === -1) {
                speak(`We're about to make ${recipe.title}. ${handsFreeMode ? 'Say "Hey Coach, ready!"' : 'Click next'} when you want to begin!`);
            }
        }

        function showHelp() {
            const commands = handsFreeMode ? 
                "You can say: Hey Coach ready, Hey Coach next, Hey Coach previous, Hey Coach repeat, Hey Coach start timer, or Hey Coach help. You can also use the buttons anytime!" :
                "You can say: ready, next, previous, repeat, or help. Or simply use the colorful buttons below!";
            speak(`No problem! ${commands}`);
        }

        function startCurrentStepTimer() {
            if (currentStep >= 0 && currentStep < recipe.steps.length) {
                const step = recipe.steps[currentStep];
                if (step.time) {
                    startTimer(step.time, `Step ${step.number}`);
                } else {
                    speak("This step doesn't have a specific time. Just let me know when you're ready for the next step!");
                }
            }
        }

        function startTimer(minutes, label) {
            const timerId = Date.now();
            const endTime = Date.now() + (minutes * 60 * 1000);
            
            timers.set(timerId, {
                label: label,
                endTime: endTime,
                minutes: minutes
            });
            
            speak(`Perfect! Timer set for ${minutes} minutes. I'll let you know when it's done! Keep cooking, superstar!`);
            updateTimersDisplay();
            
            setTimeout(() => {
                timerComplete(timerId);
            }, minutes * 60 * 1000);
        }

        function timerComplete(timerId) {
            const timer = timers.get(timerId);
            if (!timer) return;
            
            // Alert with enthusiasm!
            speak(`Ding ding ding! Timer's up! Your ${timer.label} is ready! You're doing amazing!`);
            
            timers.delete(timerId);
            updateTimersDisplay();
        }

        function updateTimersDisplay() {
            const timersSection = document.getElementById('timersSection');
            const timersList = document.getElementById('timersList');
            
            if (timers.size === 0) {
                timersSection.style.display = 'none';
                return;
            }
            
            timersSection.style.display = 'block';
            timersList.innerHTML = '';
            
            timers.forEach((timer, id) => {
                const remaining = Math.max(0, timer.endTime - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                const timerElement = document.createElement('div');
                timerElement.className = 'timer-item';
                timerElement.innerHTML = `
                    <span class="timer-label">${timer.label}</span>
                    <span class="timer-time">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                `;
                timersList.appendChild(timerElement);
            });
            
            if (!window.timerInterval) {
                window.timerInterval = setInterval(updateTimersDisplay, 1000);
            }
        }

        function checkTimers() {
            if (timers.size === 0) {
                speak("No timers running right now!");
                return;
            }
            
            let timerInfo = "Here are your active timers: ";
            timers.forEach((timer) => {
                const remaining = Math.max(0, timer.endTime - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                timerInfo += `${timer.label} has ${minutes} minutes and ${seconds} seconds left. `;
            });
            
            speak(timerInfo);
        }

        function completeRecipe() {
            cookingInterface.style.display = 'none';
            completionScreen.style.display = 'block';
            voiceIndicator.style.display = 'none';
            
            continuousListening = false;
            stopListening();
            
            if (window.timerInterval) {
                clearInterval(window.timerInterval);
                window.timerInterval = null;
            }
            
            speak("Woohoo! You did it! You're officially a kitchen rockstar! Your delicious creation is ready to enjoy. I'm so proud of you!");
        }

        // Enhanced sample recipes
        const sampleRecipes = {
            cookies: `Best Ever Chocolate Chip Cookies

Ingredients:
- 2¼ cups all-purpose flour
- 1 cup butter, softened
- ¾ cup granulated sugar
- ¾ cup packed brown sugar
- 2 large eggs
- 2 teaspoons vanilla extract
- 1 teaspoon baking soda
- 1 teaspoon salt
- 2 cups chocolate chips

Instructions:
1. Preheat your oven to 375°F (190°C). This is the perfect temperature for golden, chewy cookies!
2. In a small bowl, whisk together the flour, baking soda, and salt until well combined. Set this aside for now.
3. In a large mixing bowl, beat the softened butter with both sugars until the mixture is light and fluffy, about 3-4 minutes of mixing.
4. Add the eggs one at a time to the butter mixture, beating well after each addition. Then mix in the vanilla extract.
5. Gradually add the flour mixture to the wet ingredients, mixing on low speed until just combined. Don't overmix!
6. Fold in the chocolate chips with a wooden spoon or spatula, making sure they're evenly distributed throughout the dough.
7. Using a cookie scoop or spoon, drop rounded tablespoons of dough onto ungreased baking sheets, spacing them about 2 inches apart.
8. Bake for 9-11 minutes, until the edges are golden brown but the centers still look slightly underdone.
9. Let the cookies cool on the baking sheet for 2 minutes, then transfer them to a wire rack to cool completely.
10. Enjoy your amazing homemade chocolate chip cookies with a glass of cold milk!`,

            pasta: `Quick & Delicious Garlic Pasta

Ingredients:
- 1 pound spaghetti or linguine
- 6 cloves garlic, minced
- ½ cup extra virgin olive oil
- ¼ teaspoon red pepper flakes
- Salt and black pepper to taste
- ½ cup fresh parsley, chopped
- 1 cup freshly grated Parmesan cheese
- Zest of 1 lemon (optional)

Instructions:
1. Fill a large pot with water, add a generous amount of salt, and bring to a rolling boil over high heat.
2. Add the pasta to the boiling water and cook according to package directions until al dente, usually 8-10 minutes.
3. While the pasta is cooking, heat the olive oil in a large skillet over medium heat until it shimmers.
4. Add the minced garlic and red pepper flakes to the hot oil, stirring constantly for about 2 minutes until fragrant but not browned.
5. When the pasta is ready, reserve 1 cup of the starchy pasta water before draining in a colander.
6. Add the drained pasta directly to the skillet with the garlic oil and toss everything together over medium heat.
7. Add pasta water a little at a time, tossing constantly, until you reach your desired sauce consistency.
8. Remove from heat and add the fresh parsley and half of the Parmesan cheese, tossing to combine.
9. Season generously with salt and freshly ground black pepper, and add lemon zest if using.
10. Serve immediately in warm bowls, topped with the remaining Parmesan cheese and enjoy your restaurant-quality pasta!`,

            stirfry: `Colorful Veggie Stir-Fry

Ingredients:
- 2 tablespoons vegetable oil
- 1 onion, sliced
- 2 bell peppers (any color), sliced
- 2 cups broccoli florets
- 1 cup snap peas
- 3 cloves garlic, minced
- 1 tablespoon fresh ginger, minced
- 3 tablespoons soy sauce
- 1 tablespoon sesame oil
- 1 teaspoon cornstarch
- 2 tablespoons water
- Cooked rice for serving

Instructions:
1. Heat a large wok or skillet over high heat until it's smoking hot - this is key for a great stir-fry!
2. Add the vegetable oil and swirl to coat the pan, then immediately add the onion slices and stir-fry for 1 minute.
3. Add the bell peppers and broccoli to the pan, stirring constantly for 3-4 minutes until they start to soften but still have crunch.
4. Toss in the snap peas, garlic, and ginger, continuing to stir-fry for another 2 minutes until everything is fragrant.
5. In a small bowl, whisk together the soy sauce, sesame oil, cornstarch, and water to make your sauce.
6. Push the vegetables to the sides of the pan, creating a well in the center, and pour in the sauce mixture.
7. Let the sauce bubble and thicken for about 30 seconds, then toss everything together until the vegetables are coated.
8. Remove from heat immediately to keep the vegetables crisp and vibrant.
9. Serve your beautiful stir-fry over fluffy rice and feel proud of this healthy, delicious meal!
10. Garnish with sesame seeds or sliced green onions if you have them, and enjoy while hot!`
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch(e.key) {
                    case '1':
                        recipeInput.value = sampleRecipes.cookies;
                        checkRecipeValidity();
                        showSuccess('🍪 Cookie recipe loaded!');
                        break;
                    case '2':
                        recipeInput.value = sampleRecipes.pasta;
                        checkRecipeValidity();
                        showSuccess('🍝 Pasta recipe loaded!');
                        break;
                    case '3':
                        recipeInput.value = sampleRecipes.stirfry;
                        checkRecipeValidity();
                        showSuccess('🥘 Stir-fry recipe loaded!');
                        break;
                }
            }
        });

        // Load voices when available
        if ('speechSynthesis' in window) {
            speechSynthesis.getVoices();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => {
                    console.log('Voices loaded:', speechSynthesis.getVoices().length);
                };
            }
        }
    </script>
</body>
</html>
