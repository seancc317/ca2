<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Coach AI - Your Hands-Free Cooking Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            flex: 1;
            animation: fadeInUp 0.8s ease-out;
            transition: all 0.3s ease;
        }

        .upload-section {
            text-align: center;
            padding: 40px 20px;
        }

        .upload-section h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .upload-box.dragover {
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.02);
        }

        .recipe-input {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            margin: 20px 0;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .recipe-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .hands-free-option {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            font-size: 1.1em;
        }

        .hands-free-option input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .start-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cooking-interface {
            display: none;
        }

        .step-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .step-number {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .step-content {
            font-size: 1.3em;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
            animation: fadeIn 0.5s ease-out;
        }

        .voice-indicator {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-indicator.listening {
            animation: pulse 1.5s infinite;
        }

        .voice-indicator.speaking {
            animation: glow 1s infinite alternate;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 4px 30px rgba(102, 126, 234, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            }
        }

        @keyframes glow {
            from {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            }
            to {
                box-shadow: 0 4px 40px rgba(118, 75, 162, 0.8);
            }
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .control-button {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .timers-section {
            margin-top: 30px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 15px;
        }

        .timer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .timer-item:last-child {
            border-bottom: none;
        }

        .timer-time {
            font-size: 1.2em;
            font-weight: bold;
            color: #764ba2;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .completion-screen {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .completion-screen h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .completion-screen p {
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .mic-icon {
            width: 40px;
            height: 40px;
            fill: white;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 8px;
            display: none;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .voice-indicator {
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
            }
            
            .mic-icon {
                width: 30px;
                height: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>Kitchen Coach AI üë®‚Äçüç≥</h1>
            <p>Your hands-free cooking assistant</p>
        </div>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <h2>Let's Cook Something Awesome!</h2>
                <p>Paste your recipe below or drag & drop a file</p>
                
                <div class="upload-box" id="uploadBox">
                    <p>üìÑ Drop recipe file here (PDF, DOC, TXT, or image)</p>
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" style="display: none;">
                </div>

                <textarea class="recipe-input" id="recipeInput" placeholder="Or paste your recipe here...

Example:
Chocolate Chip Cookies
Ingredients:
- 2 cups flour
- 1 cup butter
- 1 cup sugar
...

Instructions:
1. Preheat oven to 350¬∞F
2. Mix butter and sugar..."></textarea>

                <div class="hands-free-option">
                    <input type="checkbox" id="handsFreeModeCheckbox">
                    <label for="handsFreeModeCheckbox">Enable hands-free mode (wake word: "Hey Coach")</label>
                </div>

                <button class="start-button" id="startButton" disabled>Start Cooking!</button>
                
                <div class="error-message" id="errorMessage"></div>
            </div>

            <!-- Cooking Interface -->
            <div class="cooking-interface" id="cookingInterface">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="step-display">
                    <div class="step-number" id="stepNumber"></div>
                    <div class="step-content" id="stepContent"></div>
                </div>

                <div class="control-buttons">
                    <button class="control-button" id="prevButton">Previous</button>
                    <button class="control-button" id="repeatButton">Repeat</button>
                    <button class="control-button" id="nextButton">Next</button>
                    <button class="control-button" id="helpButton">Help</button>
                </div>

                <div class="timers-section" id="timersSection" style="display: none;">
                    <h3>Active Timers</h3>
                    <div id="timersList"></div>
                </div>
            </div>

            <!-- Completion Screen -->
            <div class="completion-screen" id="completionScreen">
                <h2>üéâ You Did It!</h2>
                <p>You totally nailed this recipe! Enjoy your delicious creation!</p>
                <button class="start-button" onclick="location.reload()">Cook Something Else</button>
            </div>
        </div>

        <!-- Voice Indicator -->
        <div class="voice-indicator" id="voiceIndicator" style="display: none;">
            <svg class="mic-icon" viewBox="0 0 24 24">
                <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" />
            </svg>
        </div>
    </div>

    <script>
        // Global state
        let recipe = null;
        let currentStep = -1;
        let isListening = false;
        let isSpeaking = false;
        let handsFreeMode = false;
        let recognition = null;
        let timers = new Map();
        let continuousListening = false;

        // DOM elements
        const uploadSection = document.getElementById('uploadSection');
        const cookingInterface = document.getElementById('cookingInterface');
        const completionScreen = document.getElementById('completionScreen');
        const voiceIndicator = document.getElementById('voiceIndicator');
        const recipeInput = document.getElementById('recipeInput');
        const startButton = document.getElementById('startButton');
        const errorMessage = document.getElementById('errorMessage');
        const handsFreeModeCheckbox = document.getElementById('handsFreeModeCheckbox');
        const fileInput = document.getElementById('fileInput');
        const uploadBox = document.getElementById('uploadBox');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            checkBrowserSupport();
        });

        function setupEventListeners() {
            recipeInput.addEventListener('input', checkRecipeValidity);
            startButton.addEventListener('click', startCooking);
            uploadBox.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('dragover');
            });
            
            uploadBox.addEventListener('dragleave', () => {
                uploadBox.classList.remove('dragover');
            });
            
            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // Control buttons
            document.getElementById('prevButton').addEventListener('click', previousStep);
            document.getElementById('nextButton').addEventListener('click', nextStep);
            document.getElementById('repeatButton').addEventListener('click', repeatStep);
            document.getElementById('helpButton').addEventListener('click', showHelp);
            
            voiceIndicator.addEventListener('click', toggleListening);
        }

        function checkBrowserSupport() {
            // Check for HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showError('This app requires HTTPS for voice features. Please use a secure connection.');
            }
            
            if (!('speechSynthesis' in window)) {
                showError('Your browser doesn\'t support text-to-speech. Please use a modern browser.');
            }
            
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showError('Your browser doesn\'t support speech recognition. Voice commands will be disabled.');
                // Disable hands-free checkbox
                handsFreeModeCheckbox.disabled = true;
                handsFreeModeCheckbox.parentElement.style.opacity = '0.5';
            }
        }

        function checkRecipeValidity() {
            const hasContent = recipeInput.value.trim().length > 50;
            startButton.disabled = !hasContent;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            // Don't auto-hide critical errors
            if (!message.includes('permission') && !message.includes('HTTPS')) {
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // For MVP, we'll just show a message about file upload
            showError('File upload parsing coming soon! Please paste your recipe text for now.');
            
            // In a real implementation, you'd parse PDFs, images, etc.
            // For now, let's simulate with a placeholder
            recipeInput.value = `[Recipe from ${file.name}]\n\nPlease paste the recipe text for now.`;
            checkRecipeValidity();
        }

        function handleFiles(files) {
            if (files.length > 0) {
                handleFileUpload({ target: { files: [files[0]] } });
            }
        }

        function parseRecipe(recipeText) {
            // Simple recipe parser for MVP
            const lines = recipeText.trim().split('\n').filter(line => line.trim());
            const steps = [];
            
            // Look for numbered steps or lines that look like instructions
            let inInstructions = false;
            let stepNumber = 1;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                // Check if we're in the instructions section
                if (trimmed.toLowerCase().includes('instruction') || 
                    trimmed.toLowerCase().includes('direction') ||
                    trimmed.toLowerCase().includes('method')) {
                    inInstructions = true;
                    return;
                }
                
                // Parse numbered steps
                const numberedMatch = trimmed.match(/^(\d+)[\.\)]\s*(.+)/);
                if (numberedMatch) {
                    steps.push({
                        number: stepNumber++,
                        text: numberedMatch[2],
                        time: extractTime(numberedMatch[2])
                    });
                } else if (inInstructions && trimmed.length > 20 && !trimmed.includes(':')) {
                    // Assume longer lines after "Instructions" are steps
                    steps.push({
                        number: stepNumber++,
                        text: trimmed,
                        time: extractTime(trimmed)
                    });
                }
            });
            
            // Extract recipe title (usually first line)
            const title = lines[0] || 'Your Recipe';
            
            return {
                title: title,
                steps: steps.length > 0 ? steps : generateDefaultSteps(recipeText),
                totalSteps: steps.length || 3
            };
        }

        function extractTime(text) {
            // Extract cooking times from step text
            const timeMatch = text.match(/(\d+)\s*(minutes?|mins?|hours?|hrs?|seconds?|secs?)/i);
            if (timeMatch) {
                const value = parseInt(timeMatch[1]);
                const unit = timeMatch[2].toLowerCase();
                
                if (unit.includes('hour')) return value * 60;
                if (unit.includes('sec')) return value / 60;
                return value; // Default to minutes
            }
            return null;
        }

        function generateDefaultSteps(recipeText) {
            // Fallback if we can't parse steps properly
            return [
                { number: 1, text: "Gather all your ingredients and equipment", time: null },
                { number: 2, text: "Follow the recipe instructions", time: null },
                { number: 3, text: "Enjoy your delicious creation!", time: null }
            ];
        }

        function startCooking() {
            const recipeText = recipeInput.value.trim();
            if (!recipeText) return;
            
            recipe = parseRecipe(recipeText);
            handsFreeMode = handsFreeModeCheckbox.checked;
            
            // Initialize voice recognition if hands-free mode
            if (handsFreeMode) {
                initializeVoiceRecognition();
            }
            
            // Switch to cooking interface
            uploadSection.style.display = 'none';
            cookingInterface.style.display = 'block';
            voiceIndicator.style.display = handsFreeMode ? 'flex' : 'none';
            
            // Start with welcome message
            speak(`Awesome! We're making ${recipe.title}. When you're ready to start, ${handsFreeMode ? 'say "Hey Coach, ready!"' : 'click next or say "ready"'}`);
            
            updateStepDisplay();
        }

        function initializeVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                if (isSpeaking) return; // Don't process while speaking
                
                const last = event.results.length - 1;
                const command = event.results[last][0].transcript.toLowerCase();
                
                console.log('Heard:', command);
                
                // Check for wake word in hands-free mode
                if (handsFreeMode) {
                    if (command.includes('hey coach')) {
                        processCommand(command.replace('hey coach', '').trim());
                    }
                } else {
                    processCommand(command);
                }
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                // Handle different error types
                switch(event.error) {
                    case 'not-allowed':
                        // Microphone permission denied
                        showError('Microphone access denied. Please allow microphone access and reload the page.');
                        continuousListening = false;
                        handsFreeMode = false;
                        voiceIndicator.style.display = 'none';
                        break;
                    case 'no-speech':
                        // No speech detected - this is normal, just restart if needed
                        if (continuousListening && !isSpeaking) {
                            setTimeout(() => {
                                if (continuousListening && !isSpeaking) {
                                    startListening();
                                }
                            }, 100);
                        }
                        break;
                    case 'network':
                        showError('Network error. Please check your internet connection.');
                        break;
                    case 'aborted':
                        // Recognition was aborted, try to restart if needed
                        if (continuousListening && !isSpeaking) {
                            setTimeout(() => {
                                if (continuousListening && !isSpeaking) {
                                    startListening();
                                }
                            }, 500);
                        }
                        break;
                    default:
                        // For other errors, show message but don't stop trying
                        console.log('Speech recognition error:', event.error);
                }
            };
            
            recognition.onend = () => {
                isListening = false;
                voiceIndicator.classList.remove('listening');
                
                // Restart if continuous listening is enabled and no errors
                if (continuousListening && !isSpeaking && handsFreeMode) {
                    setTimeout(() => {
                        if (continuousListening && handsFreeMode) {
                            startListening();
                        }
                    }, 100);
                }
            };
            
            // Request microphone permission first
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        console.log('Microphone permission granted');
                        // Start continuous listening if hands-free mode
                        if (handsFreeMode) {
                            continuousListening = true;
                            startListening();
                        }
                    })
                    .catch((err) => {
                        console.error('Microphone permission denied:', err);
                        showError('Microphone access is required for voice commands. Please allow access and reload.');
                        handsFreeMode = false;
                        voiceIndicator.style.display = 'none';
                    });
            } else {
                // Fallback for browsers without getUserMedia
                if (handsFreeMode) {
                    continuousListening = true;
                    startListening();
                }
            }
        }

        function startListening() {
            if (!recognition || isListening || isSpeaking) return;
            
            try {
                recognition.start();
                isListening = true;
                voiceIndicator.classList.add('listening');
                console.log('Started listening');
            } catch (e) {
                console.error('Failed to start recognition:', e);
                // If we get an error starting, it might be because it's already running
                // Stop it first, then try again
                if (e.name === 'InvalidStateError') {
                    recognition.stop();
                    setTimeout(() => {
                        try {
                            recognition.start();
                            isListening = true;
                            voiceIndicator.classList.add('listening');
                        } catch (e2) {
                            console.error('Failed to restart recognition:', e2);
                        }
                    }, 100);
                }
            }
        }

        function stopListening() {
            if (!recognition || !isListening) return;
            
            recognition.stop();
            isListening = false;
            voiceIndicator.classList.remove('listening');
        }

        function toggleListening() {
            if (isListening) {
                continuousListening = false;
                stopListening();
            } else {
                continuousListening = true;
                startListening();
            }
        }

        function processCommand(command) {
            console.log('Processing command:', command);
            
            // Voice commands
            if (command.includes('ready') || command.includes('start') || command.includes('let\'s go')) {
                if (currentStep === -1) nextStep();
            } else if (command.includes('next') || command.includes('done') || command.includes('finished')) {
                nextStep();
            } else if (command.includes('previous') || command.includes('back') || command.includes('last')) {
                previousStep();
            } else if (command.includes('repeat') || command.includes('again') || command.includes('say that')) {
                repeatStep();
            } else if (command.includes('help') || command.includes('what')) {
                showHelp();
            } else if (command.includes('time') || command.includes('timer')) {
                checkTimers();
            } else if (command.includes('it\'s in') || command.includes('timer') || command.includes('start timer')) {
                // Start timer for current step if it has one
                if (recipe.steps[currentStep] && recipe.steps[currentStep].time) {
                    startTimer(recipe.steps[currentStep].time, `Step ${currentStep + 1}`);
                }
            }
        }

        function speak(text) {
            if (isSpeaking) return;
            
            isSpeaking = true;
            stopListening(); // Stop listening while speaking
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            utterance.volume = 1;
            
            voiceIndicator.classList.add('speaking');
            
            utterance.onend = () => {
                isSpeaking = false;
                voiceIndicator.classList.remove('speaking');
                
                // Resume listening if continuous mode
                if (continuousListening) {
                    setTimeout(() => startListening(), 500);
                }
            };
            
            speechSynthesis.speak(utterance);
        }

        function updateStepDisplay() {
            const progressFill = document.getElementById('progressFill');
            const stepNumber = document.getElementById('stepNumber');
            const stepContent = document.getElementById('stepContent');
            
            if (currentStep === -1) {
                stepNumber.textContent = 'Ready to Start';
                stepContent.textContent = `We'll be making ${recipe.title} in ${recipe.totalSteps} steps`;
                progressFill.style.width = '0%';
            } else if (currentStep < recipe.steps.length) {
                const step = recipe.steps[currentStep];
                stepNumber.textContent = `Step ${step.number} of ${recipe.totalSteps}`;
                stepContent.textContent = step.text;
                progressFill.style.width = `${((currentStep + 1) / recipe.totalSteps) * 100}%`;
                
                // Check for timers in this step
                if (step.time) {
                    speak(`${step.text}. This will take about ${step.time} minutes. Once it's ready, say "Hey Coach, it's in" and I'll start the timer.`);
                } else {
                    speak(step.text);
                }
            }
            
            // Update button states
            document.getElementById('prevButton').disabled = currentStep <= -1;
            document.getElementById('nextButton').disabled = currentStep >= recipe.steps.length - 1;
        }

        function nextStep() {
            if (currentStep < recipe.steps.length - 1) {
                currentStep++;
                updateStepDisplay();
                
                // Check if we're done
                if (currentStep === recipe.steps.length - 1) {
                    setTimeout(() => {
                        speak("Great job! You're on the final step!");
                    }, 3000);
                }
            } else if (currentStep === recipe.steps.length - 1) {
                // Complete the recipe
                completeRecipe();
            }
        }

        function previousStep() {
            if (currentStep > -1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function repeatStep() {
            if (currentStep >= 0 && currentStep < recipe.steps.length) {
                speak(recipe.steps[currentStep].text);
            } else if (currentStep === -1) {
                speak(`We'll be making ${recipe.title}. When you're ready to start, ${handsFreeMode ? 'say "Hey Coach, ready!"' : 'click next or say "ready"'}`);
            }
        }

        function showHelp() {
            const helpText = handsFreeMode ? 
                "You can say: Hey Coach ready, Hey Coach next, Hey Coach previous, Hey Coach repeat, or Hey Coach help" :
                "You can say: ready, next, previous, repeat, or help. Or use the buttons below.";
            speak(helpText);
        }

        function startTimer(minutes, label) {
            const timerId = Date.now();
            const endTime = Date.now() + (minutes * 60 * 1000);
            
            timers.set(timerId, {
                label: label,
                endTime: endTime,
                minutes: minutes
            });
            
            speak(`Timer set for ${minutes} minutes. I'll let you know when it's done!`);
            updateTimersDisplay();
            
            // Set the actual timer
            setTimeout(() => {
                timerComplete(timerId);
            }, minutes * 60 * 1000);
        }

        function timerComplete(timerId) {
            const timer = timers.get(timerId);
            if (!timer) return;
            
            // Play alert sound (using speech as audio)
            speak(`Timer complete! Your ${timer.label} is ready!`);
            
            // Remove timer
            timers.delete(timerId);
            updateTimersDisplay();
        }

        function updateTimersDisplay() {
            const timersSection = document.getElementById('timersSection');
            const timersList = document.getElementById('timersList');
            
            if (timers.size === 0) {
                timersSection.style.display = 'none';
                return;
            }
            
            timersSection.style.display = 'block';
            timersList.innerHTML = '';
            
            timers.forEach((timer, id) => {
                const remaining = Math.max(0, timer.endTime - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                const timerElement = document.createElement('div');
                timerElement.className = 'timer-item';
                timerElement.innerHTML = `
                    <span>${timer.label}</span>
                    <span class="timer-time">${minutes}:${seconds.toString().padStart(2, '0')}</span>
                `;
                timersList.appendChild(timerElement);
            });
            
            // Update display every second
            if (!window.timerInterval) {
                window.timerInterval = setInterval(updateTimersDisplay, 1000);
            }
        }

        function checkTimers() {
            if (timers.size === 0) {
                speak("No active timers");
                return;
            }
            
            let timerInfo = "Active timers: ";
            timers.forEach((timer) => {
                const remaining = Math.max(0, timer.endTime - Date.now());
                const minutes = Math.floor(remaining / 60000);
                timerInfo += `${timer.label} has ${minutes} minutes remaining. `;
            });
            
            speak(timerInfo);
        }

        function completeRecipe() {
            cookingInterface.style.display = 'none';
            completionScreen.style.display = 'block';
            voiceIndicator.style.display = 'none';
            
            // Stop any listeners
            continuousListening = false;
            stopListening();
            
            // Clear timers
            if (window.timerInterval) {
                clearInterval(window.timerInterval);
                window.timerInterval = null;
            }
            
            speak("You totally nailed it! Enjoy your delicious creation!");
        }

        // Add some sample recipes for testing
        const sampleRecipes = {
            cookies: `Chocolate Chip Cookies

Ingredients:
- 2¬º cups all-purpose flour
- 1 cup butter, softened
- ¬æ cup granulated sugar
- ¬æ cup packed brown sugar
- 2 large eggs
- 2 teaspoons vanilla extract
- 1 teaspoon baking soda
- 1 teaspoon salt
- 2 cups chocolate chips

Instructions:
1. Preheat your oven to 375¬∞F (190¬∞C).
2. In a small bowl, mix together the flour, baking soda, and salt. Set aside.
3. In a large bowl, beat the softened butter with both sugars until creamy, about 3-4 minutes.
4. Add eggs and vanilla to the butter mixture and beat well until combined.
5. Gradually add the flour mixture to the wet ingredients, mixing until just combined.
6. Fold in the chocolate chips until evenly distributed throughout the dough.
7. Drop rounded tablespoons of dough onto ungreased baking sheets, spacing them about 2 inches apart.
8. Bake for 9-11 minutes, or until the edges are golden brown.
9. Cool on baking sheets for 2 minutes, then transfer to wire racks.
10. Enjoy your homemade chocolate chip cookies!`,

            pasta: `Simple Garlic Pasta

Ingredients:
- 1 pound spaghetti
- 6 cloves garlic, minced
- ¬Ω cup olive oil
- ¬º teaspoon red pepper flakes
- Salt and black pepper to taste
- ¬Ω cup fresh parsley, chopped
- 1 cup grated Parmesan cheese

Instructions:
1. Bring a large pot of salted water to a boil.
2. Add the spaghetti and cook according to package directions until al dente, usually 8-10 minutes.
3. While pasta cooks, heat olive oil in a large skillet over medium heat.
4. Add minced garlic and red pepper flakes to the oil. Cook for 2 minutes until garlic is fragrant but not brown.
5. When pasta is done, reserve 1 cup of pasta water before draining.
6. Add drained pasta to the skillet with garlic oil.
7. Toss pasta with the garlic oil, adding pasta water a little at a time until you reach desired consistency.
8. Remove from heat and add parsley and half the Parmesan cheese. Toss well.
9. Season with salt and pepper to taste.
10. Serve immediately with remaining Parmesan cheese on top.`
        };

        // Add keyboard shortcuts for testing
        document.addEventListener('keydown', (e) => {
            if (e.altKey) {
                switch(e.key) {
                    case '1':
                        recipeInput.value = sampleRecipes.cookies;
                        checkRecipeValidity();
                        break;
                    case '2':
                        recipeInput.value = sampleRecipes.pasta;
                        checkRecipeValidity();
                        break;
                }
            }
        });
    </script>
</body>
</html>
